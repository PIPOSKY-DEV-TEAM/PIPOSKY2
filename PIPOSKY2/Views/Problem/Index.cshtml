@using PIPOSKY2.Models 
@model IEnumerable<Problem>
@{
    bool editRight = false;
    User tmp = Session["User"] as User;
    if ((tmp != null) && (tmp.UserType == "admin" || tmp.UserType == "editor"))
    {
         editRight = true;
    }
    PIPOSKY2DbContext db = new PIPOSKY2DbContext();
    PIPOSKY2DbContext dbtemp = new PIPOSKY2DbContext();
}
@{
    ViewBag.Title = "题目列表";
}
<h2>题目列表</h2> 
@{
    if (editRight)
    {
        <p>
            @Html.ActionLink("上传题目", "Upload", "Problem", null, new { @class = "btn btn-default" })
            @Html.ActionLink("删除题目", "Delete", "Problem", null, new { @class = "btn btn-default" })
        </p>
    }
}

<table class="table table-striped">
    <tr>
        <th>题目名称</th>
        <th>题目得分</th>
        @{if (editRight) 
          {
              <th>上传用户</th>
              <th>操作</th>
        }}
    </tr>
    @foreach (Problem i in Model)
    {
        if (editRight || i.Visible)
        {
            <tr>
                <td>@Html.ActionLink(@i.ProblemName, "Content", new { id = @i.ProblemID, type="Exam"})</td>        
                @{
                    if (tmp == null)
                    {
                        <td>无记录</td>
                    }
                    else
                    {
                        IQueryable<Submit> t = dbtemp.Submits.Where(s => s.Prob.ProblemID == i.ProblemID && s.User.UserID == tmp.UserID);
                        if (t.Count() == 0)
                        {
                            <td>无记录</td>
                        }
                        else
                        {
                            <td>@t.ToList().Last().Score</td>
                        }
                    }
                }
                @{
                    if (editRight)
                    {
                        <td>@i.Creator.UserName</td>
                        <td>
                            @Html.ActionLink("编辑题目", "Edit", new { id= @i.ProblemID})
                            |
                            @Html.ActionLink("下载数据", "Download", new { id= @i.ProblemID})
                        </td>
                    }
                }
            </tr>
        }
    }
</table>
